{% extends 'layout_underground.html' %}

{% block body %}

    <div class="container">
        <div class="row">
            <div class="jumbotron my-4 justify-content-center" id="messagebox" style="height: auto !important; overflow: auto; max-height: 470px !important;">
                <div class="d-flex flex-row ">
                    <div class="col-lg-4">
                        <div class="card text-white bg-info mb-3">
                            <div class="card-header">{{ session.room }}</div>
                            <div class="card-body">
                                <h4 class="card-title">Auto generated message</h4>
                                <p class="card-text text-white">Welcome {{ session.user }}</p>
                                <p class="card-text text-white">Press Alt + L to Traverse through available rooms</p>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="jumbotron mb-2">
            <div class="form-inline justify-content-center">
                <label class="sr-only" for="sendMessage"></label>
                <textarea type="text" class="form-control mb-2 mr-sm-2 bg-dark col-lg-10" id="message" style="resize: none" placeholder="Message"></textarea>
                <button type="button" id="send" class="btn btn-success">Submit</button>
            </div>

            <div class="row justify-content-center">
                <button  class="btn btn-warning mr-3">Warn!</button>
                <button id="disconnect" class="btn btn-danger mr-3">Disconnect!</button>
                <button class="btn btn-info mr-3">Buzz!</button>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script>
        let socket = io.connect(location.protocol+ '//' + document.domain + ':' + location.port)
        $(document).ready(function (){
            if(!localStorage.getItem('room_id') && !localStorage.getItem('user_id')){
                localStorage.setItem('user_id', "{{ session.user }}")
                localStorage.setItem('room_id', "{{ session.room}}")
            }

            $("#send").on('click', function (){
                let message = $("#message")
                prevent_blank_text()
                let message_data = {message: message.val(), timestamp: new Date().toDateString(), user_id:"{{ session.user }}", room_id:"{{ session.room }}"}
                console.log(message_data)

                message.val('')
                socket.emit('send', {message_data})
            })

            socket.on('connect', function (){
                socket.emit('join channel', {})
            })


            socket.emit('create channel',{"user_id": "{{ session.user }}", "room_id": "{{ session.room }}"})
            socket.on('broadcast message', function (data){
                $("#messagebox").append(`
                <div class="d-flex flex-row ">
                    <div class="col-lg-4">
                        <div class="card text-white bg-dark mb-3">
                            <div class="card-header">${data.message_data['user_id']}</div>
                            <div class="card-body">
                                <h4 class="card-title">${data.message_data['timestamp']}</h4>
                                <p class="card-text text-white">${data.message_data['message']}</p>

                            </div>
                        </div>
                    </div>
                </div>`)
            })

        })

        socket.on('channel created', function (data){
            alert(`${data.user_id} has created a room`)
        })
        $("#disconnect").on('click', function (e){
            e.preventDefault()
            socket.emit('leave channel', {"user_id": "{{ session.user }}", "room_id": "{{ session.room }}"}, function (){
                socket.disconnect()
                localStorage.removeItem("user_id")
                localStorage.removeItem("room_id")
            })
        })
        function prevent_blank_text(){
            $("#send").attr('disabled', true)

            // pseudo validator
            $("#message").on('keyup', function (e){
                if ($("#message").val().length > 0){
                    $("#send").attr('disabled', false)
                }else{
                    $("#send").attr('disabled', true)
                }
            })
        }
        function generate_random_string(is_num){
            let salt_table = "1234567890abcdefghijklmnopqrstuvwxyz"
            let salt_table_numeric = "123456789"
            let random_string = ""
            for(let i = 0; i <= 10; ++i){
                random_string += is_num ? salt_table_numeric[Math.floor(Math.random() * 9)] : salt_table[Math.floor(Math.random() * 35)]
            }
            return random_string
        }

    </script>
{% endblock %}