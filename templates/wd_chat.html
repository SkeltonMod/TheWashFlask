{% extends 'layout_underground.html' %}

{% block body %}

    <div class="container">
        <div class="row" id="rowcont">
            <div class="jumbotron my-4 justify-content-center" id="messagebox" style="height: auto !important; overflow: auto; max-height: 470px !important;">
                <div class="d-flex flex-row ">
                    <div class="col-lg-4">
                        <div class="card text-white bg-info mb-3">
                            <div class="card-header">System</div>
                            <div class="card-body" id="system_body">
                                <h4 class="card-title">Auto generated message</h4>
                                <p class="card-text text-white">Facebook chat wrapper v1 Beta</p>
                                <p class="card-text text-white">Currently in: {{ room_id }}</p>
                                <p class="card-text text-white">ROOM ID: {{ user_id }}</p>
                                <p class="card-text text-white">Please Note that you will be warned 3 times
                                    before getting disconnected</p>
                                <p class="card-text text-white">To initiate a query again please talk to the
                                    chat bot.</p>
                                <p class="card-text text-white">Thanks!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="jumbotron mb-2">
            <div class="form-inline justify-content-center">
                <label class="sr-only" for="sendMessage"></label>
                <label for="message"></label><textarea type="text" class="form-control mb-2 mr-sm-2 bg-dark col-lg-10" id="message" style="resize: none" placeholder="Message"></textarea>

                <button type="button" id="send" class="btn btn-success">Send</button>
            </div>
            <div class="row justify-content-center">
                <button id="disconnect" class="btn btn-danger mr-3">Disconnect!</button>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script>
        let socket = io.connect(location.protocol+ '//' + document.domain + ':' + location.port)

        $(document).ready(function (){
            if(!localStorage.getItem('room_id') && !localStorage.getItem('user_id')){
                localStorage.setItem('user_id', "{{ user_id }}")
                localStorage.setItem('room_id', "{{ room_id }}")
            }

            $("#send").on('click', function (){
                let message = $("#message")
                prevent_blank_text()
                let message_data = {message: message.val(), timestamp: new Date().toDateString(), user_id:"{{ user_id }}", room_id:"{{ room_id }}"}
                console.log(message_data)

                message.val('')
                socket.emit('send', {message_data})
            })
            socket.emit('create channel',{"user_id": "{{ user_id }}", "room_id": "{{ room_id }}"})
            socket.emit('load message', {"room_id": "{{ room_id }}"})
            socket.on('broadcast message', function (data){
                let user_id = "{{ user_id }}"
                let owner = (data['message_data'].user_id === user_id)
                console.log(`${owner}: ${data['message_data'].user_id}->${user_id}`)
                $("#messagebox").append(`
                <div class="d-flex ${owner ? "flex-row-reverse": "flex-row"}">
                    <div class="col-lg-4">
                        <div class="card text-white bg-dark mb-3">
                            <div class="card-header">${data.message_data['user_id']}</div>
                            <div class="card-body">
                                <h4 class="card-title">${data.message_data['timestamp']}</h4>
                                <p class="card-text text-white">${data.message_data['message']}</p>
                            </div>
                        </div>
                    </div>
                </div>`)
            })
        })

        $("#disconnect").on('click', function (e){
            e.preventDefault()
            socket.emit('leave channel', {"user_id": "{{ user_id }}", "room_id": "{{ room_id }}"}, function (){
                socket.disconnect()
                localStorage.removeItem("user_id")
                localStorage.removeItem("room_id")
                window.location.href = "/404"
            })
        })

        socket.on('user kicked', function (channel_data){
            socket.disconnect()
            localStorage.removeItem("user_id")
            localStorage.removeItem("room_id")
            window.location.href = "/disconnected"
        })

        function prevent_blank_text(){
            $("#send").attr('disabled', true)

            // pseudo validator
            $("#message").on('keyup', function (e){
                if ($("#message").val().length > 0){
                    $("#send").attr('disabled', false)
                }else{
                    $("#send").attr('disabled', true)
                }
            })
        }

        </script>
{% endblock %}